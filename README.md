# Hybrid Passive–Active Shimming and Least-Squares

A low-cost MRI B₀ shimming concept that links concrete 3D hardware with a simple least-squares shimming experiment on real spinal-cord data.

## Hardware Design

<img width="4942" height="1024" alt="image" src="https://github.com/user-attachments/assets/0a0ca4d3-266e-4386-9bf7-175789bc16f7" />

## Software Implementation

<img width="5234" height="3296" alt="image" src="https://github.com/user-attachments/assets/c6f29b7f-a3c3-4e7d-a577-2648efcef2c4" />

<img width="4161" height="3542" alt="image" src="https://github.com/user-attachments/assets/178bc9dd-906c-4662-9554-1a11daf2aa6c" />

### Least-Squares B₀ Formulation

We consider:

- A **baseline B₀ field map** in the region of interest (ROI), denoted `baseline_roi` (Hz or ppm).

- A set of **shim elements** (e.g., loops), each with a precomputed **B₀ basis field** over the same ROI.

- Linear superposition: the contribution of each shim element is proportional to its weight $w_i$.

The basis fields are stacked column-wise into a design matrix:

- $A_{\text{roi}} \in \mathbb{R}^{N \times K}$  
  - $N$: number of voxels in the ROI  
  - $K$: number of shim elements  
  - Column $i$: B₀ contribution of shim element $i$ (for unit weight) in all ROI voxels.

The baseline field in the ROI is:

- $\text{baseline}_{\text{roi}} \in \mathbb{R}^N$

To make the corrected field as uniform as possible, we drive it toward its own mean value. Define:

$$
\text{target} = \text{mean}(\text{baseline}_{\text{roi}}) - \text{baseline}_{\text{roi}}.
$$

The optimization problem 

$$
\min_w \; \|A_{\text{roi}} w - \text{target}\|^2
\quad \text{sujeto a} \quad -1000{,}0 \le w_i \le 1000{,}0 \;\; \forall i.
$$

Here:

- $A_{\text{roi}} w$ is the **correction field** generated by the shim elements.

- `target` encodes, voxel by voxel, how far the baseline is from the mean.

- Minimizing this least-squares objective reduces the **variance (and therefore the standard deviation)** of the corrected B₀ field within the ROI.

Optionally, a Tikhonov term $\lambda \|w\|^2$ can be added:

$$
\min_w \; \|A_{\text{roi}} w - \text{target}\|^2 + \lambda \|w\|^2
\quad \text{sujeto a} \quad -1000{,}0 \le w_i \le 1000{,}0 \;\; \forall i,
$$

trading off homogeneity against the magnitude of the shim weights.
